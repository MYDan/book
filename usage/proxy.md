# 网络代理

截止到上一节，您已经可以方便的在同机房内进行批量的操作、传输文件和获取远程shell。但是真实的网络环境可能很复杂。您的机器可能分布在多地区的多个机房，或者在网络不通的公有云的region中。这个时候就需要配置代理。


# 三种网络拓扑

> * 每个服务器都安装了mydan并且启动了agent，网络隔离的情况下，每个区域都选择一两台作为代理的角色，让中控机的控制流量从入口进去

## 远程命令
![rcall_exec](/assets/images/rcall_exec.png)
> * 批量操作会根据区域分布情况，把任务切割成每个区域一个，让任务在入口服务器执行，执行结束后结果汇总到中控机

## 同步文件
![grsync](/assets/images/grsync.png)
> * 同步工具指定的源机器和目标机器都可以是多个
> * 如果一个区域内即有源机器又有目标机器，数据同步的过程就会在本区域内完成，中控机只是发了一个调度任务到入口机器，入口机器来完成该区域的数据调度传输
> * 如果一个区域只有源机器没有目标机器，这个区域的同步任务会被跳过
> * 如果一个区域内没有源机器只有目标机器，中控机器会在有数据的区域通过入口服务器的网络把数据下载一份到中控机，中控机在把这个数据通过该区域的入口服务器把数据推到该区域的其中一台机器，然后在让这个区域内的服务器进行内部同步

## 远程shell
![shell](/assets/images/shell.png)
> * 中控机器mydan shell打来一个临时的端口等待反弹shell过来连接
> * 获取远程shell的指令会通过入口服务器把指令发送到要获取的服务器上
> * 反弹shell通过公网把shell反弹到中控机


# 配置
新建和编辑文件 /opt/mydan/etc/agent/proxy.private
```
[root@feng-pc ~]# cat >>  /opt/mydan/etc/agent/proxy.private << EOF
192.168.0.0/16 : 10.10.0.1
219.111.192.0/18 : 10.10.0.1
EOF
```
> * mydan会通过这个配置的信息，把需要代理的服务器进行划分，如果机器被影射到同一个代理中，这些机器就会被当作一个区域。
